# YOLO 藥品分析器 模組報告

## 概述
`yolo_pill_analyzer.py` 是一個專門用於藥品識別和標籤繪製的 Python 模組，整合了 YOLO 物件偵測模型和中文標籤處理功能。

## 主要功能

### 1. 模型管理
- **initialize_models()**: 初始化並載入 YOLO 模型
- **get_available_models()**: 回傳可用的模型列表
- 支援多個 YOLO 模型同時載入
- 錯誤處理機制，確保系統穩定性

### 2. 藥品偵測
- **detect_pills(model_name, image_pil)**: 執行藥品偵測
- 使用 YOLO 模型進行物件識別
- 回傳偵測結果包含：
  - 藥品類別名稱
  - 信心度分數
  - 邊界框座標
  - 顏色標籤

### 3. 中文標籤處理
- **_draw_custom_labels()**: 智能中文標籤繪製
- 支援正規表達式處理中文藥品名稱
- 自動移除藥品名稱中的數字和括號內容
- 智能標籤位置避免重疊

### 4. 圖像處理與上傳
- **create_and_upload_annotated_image()**: 創建標註圖像
- **upload_file_to_gcs()**: 上傳至 Google Cloud Storage
- 本地備份機制

## 技術特點

### 顏色管理
```python
COLORS = ["#FF6B6B", "#4ECDC4", "#45B7D1", "#F9A825", "#6A89CC", "#E84393", "#079992"]
```
- 使用固定顏色調色板
- 確保不同藥品有不同顏色標識

### 中文字型支援
- 多重字型檔案路徑優先級
- 支援系統字型和自定義字型
- 自動字型大小調整

### 標籤重疊處理算法
1. **多候選位置**: 左上、左下、右上、右下、內部中心
2. **細緻位置搜尋**: 步長為文字寬度的 1/6
3. **雙向搜尋**: 每個位置向左右兩個方向嘗試
4. **智能優先級**: 上方 > 下方 > 左右 > 內部
5. **距離計算**: 選擇離檢測框最近的合適位置

### 正規表達式處理
```python
# 移除引號，然後匹配中文字符直到遇到數字或括號
clean_name = drug_name_zh.replace('"', '').replace('"', '').replace('"', '')
match = re.match(r'^([^\d\(\uff08]*[\u4e00-\u9fff][^\d\(\uff08]*)', clean_name)
```
- 自動提取藥品名稱的核心中文部分
- 移除數字、括號、引號等冗餘資訊

## 錯誤處理
- 完整的異常捕獲機制
- 詳細的日誌記錄
- 優雅降級處理（GCS 不可用時使用本地存儲）

## 依賴項目
- `ultralytics`: YOLO 模型框架
- `PIL`: 圖像處理
- `google.cloud.storage`: Google Cloud Storage 整合
- `logging`: 日誌記錄
- `re`: 正規表達式處理

## 配置設定
- **MODEL_PATHS**: 模型檔案路徑配置
- **GCS_BUCKET_NAME**: Google Cloud Storage 儲存桶名稱
- **字型路徑**: 支援多種中文字型檔案

## 效能特色
- 模型預載入機制
- 連接池管理
- 快取機制
- 並行處理支援

## 使用案例
1. 醫療影像分析
2. 藥品庫存管理
3. 處方藥識別
4. 藥品安全監控

## 版本歷史
- v4: 加強標籤重疊處理和中文標籤優化
- 持續改進的字型支援和位置演算法

---
*此報告基於 yolo_pill_analyzer.py 模組分析生成*